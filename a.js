(()=>{"use strict";class t{static DetectedLanguage;static SupportedLanguages=["en","ru"];static FallbackLanguage="en";constructor(){}static Init(){this.DetectedLanguage=this.DetectUserLanguage(),this.SetAttributeToHTML()}static Pick(t){return t[this.DetectedLanguage]}static DetectUserLanguage(){for(const t of navigator.languages){const e=this.TrimLanguageCodeToCountryCode(t);if(1==this.IsLanguageSupported(e))return e}return this.FallbackLanguage}static TrimLanguageCodeToCountryCode(t){return t.slice(0,2)}static IsLanguageSupported(t){return this.SupportedLanguages.includes(t)}static SetAttributeToHTML(){document.documentElement.setAttribute("lang",this.DetectedLanguage)}}class e{constructor(){}static Init(){}}window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",(()=>{var t,e;t=document.body,e="ThemeChanging",new Promise((s=>{t.classList.toggle(e,1),setTimeout((()=>{t.classList.toggle(e,0),s()}),0)}))}));const s={English:{ID:"en",ReadableName:{en:"English",ru:"Английский"}},Numbers:{ID:"Numbers",ReadableName:{en:"Numbers",ru:"Номера"}},Russian:{ID:"ru",ReadableName:{en:"Russian",ru:"Русский"}}};class i{static FromID(t){return Object.values(s).find((e=>e.ID===t))}}class n{Value;LOCAL_STORAGE_KEY;Init(){this.Value=this.Read()}Write(){var t,e;t=this.LOCAL_STORAGE_KEY,void 0===(e=this.Stringify(this.Value))?localStorage.setItem(t,""):localStorage.setItem(t,JSON.stringify(e))}Read(){return this.Parse(function(t){const e=localStorage.getItem(t);return null===e?null:JSON.parse(e)}(this.LOCAL_STORAGE_KEY))}}const a=new class extends n{LOCAL_STORAGE_KEY="MapLanguage";Parse(t){return"string"==typeof t&&i.FromID(t)||s.English}Stringify(t){return t.ID}},o=new class extends n{LOCAL_STORAGE_KEY="PositionLanguages";Parse(t){const e=new Map;if(t){for(const s of t){const t=s[0],n=s[1],a=i.FromID(t);a&&e.set(a,n)}for(const t of Object.values(s))e.has(t)||e.set(t,1);return e}for(const t of Object.values(s))e.set(t,1);return e}Stringify(t){const e=[];for(const s of t)e.push([s[0].ID,s[1]]);return e}};class r{static MapLanguage=a;static PositionNameLanguages=o;static Init(){this.MapLanguage.Init(),this.PositionNameLanguages.Init()}}class h{static Parse(t){return{BadPractice:t.BadPractice,Language:i.FromID(t.Language),Name:t.Name,PopularityLevel:t.PopularityLevel,Source:t.Source,Story:t.Story,Warning:t.Warning}}}class c{ID;Names;VectorPath;SignatureCoordinates;constructor(t){this.ID=t.ID,this.Names=t.Names,this.VectorPath=t.VectorPath,this.SignatureCoordinates=t.SignatureCoordinates}GetPositionNameLanguages(){const t=new Set;for(const e of this.Names)0==t.has(e.Language)&&t.add(e.Language);const e=new Set;for(const i of Object.values(s))1==t.has(i)&&e.add(i);return e}GetTopNameForPositionNameLanguage(t){return this.Names.find((e=>e.Language===t))}static Parse(t){return new c({ID:t.ID,Names:t.Names.map((t=>h.Parse(t))),SignatureCoordinates:t.SignatureCoordinates,VectorPath:t.VectorPath})}}class u{static Enable(){window.addEventListener("beforeunload",this.ArrowFunction)}static Disable(){window.removeEventListener("beforeunload",this.ArrowFunction)}static ArrowFunction=t=>{t.preventDefault(),t.returnValue=0}}class l{URL;Type;ID;Data;Callback;XHR;IsAborted;constructor(t){this.URL=t.URL,this.Type=t.Type,this.ID=t.ID,this.Data=t.Data??{},this.Callback=t.Callback,this.ActiveFetches_Add(),this.PendingRequests_Add(),this.SendRequest(),this.ListenOnLoadEnd()}Abort(){this.IsAborted=1,this.XHR.abort()}SendRequest(){this.XHR=new XMLHttpRequest,"GET"===this.Type?(this.XHR.open("GET",this.URL+"?"+new URLSearchParams(this.Data)),this.XHR.send()):(this.XHR.open("POST",this.URL),this.XHR.send(this.GetForm()))}GetForm(){const t=new FormData;for(const e in this.Data)t.append(e,this.Data[e]);return t}ListenOnLoadEnd(){this.XHR.addEventListener("readystatechange",(()=>{4===this.XHR.readyState&&this.OnLoadEnd()}))}OnLoadEnd(){this.ActiveFetches_Remove(),this.PendingRequests_Remove(),this.Callback&&this.Callback({Code:this.IsAborted?"Aborted":this.XHR.status,Message:this.XHR.statusText},this.XHR.responseText)}static ActiveFetches_Count=0;ActiveFetches_Add(){0===l.ActiveFetches_Count&&u.Enable(),l.ActiveFetches_Count++}ActiveFetches_Remove(){1===l.ActiveFetches_Count&&u.Disable(),l.ActiveFetches_Count--}static PendingRequests={};PendingRequests_Add(){this.ID&&(this.ID in l.PendingRequests&&l.PendingRequests[this.ID].Abort(),l.PendingRequests[this.ID]=this)}PendingRequests_Remove(){this.ID&&delete l.PendingRequests[this.ID]}}class d{ID;ReadableName;Positions;Architecture;Ground;Width;Height;constructor(t){this.ID=t.ID,this.ReadableName=t.ReadableName,this.Positions=t.Positions,this.Architecture=t.Architecture,this.Ground=t.Ground,this.Width=t.Width,this.Height=t.Height}static Fetch(t){return new Promise((e=>{new l({Callback:(t,s)=>{200===t.Code&&e(this.Parse(JSON.parse(s)))},Type:"GET",URL:`/Assets/Output/Maps/${t}/Data.json`})}))}static Parse(t){return new d({Architecture:t.Architecture,Ground:t.Ground,Height:t.Height,ID:t.ID,Positions:t.Positions.map((t=>c.Parse(t))),ReadableName:t.ReadableName,Width:t.Width})}}class g{Listeners;constructor(t){this.Listeners=t;for(const t of this.Listeners)t.Target.addEventListener(t.EventName,t.Callback)}Destruct(){for(const t of this.Listeners)t.Target.removeEventListener(t.EventName,t.Callback)}}class m{GameMap;MyElement;Context;Listners;DragStartPoint;constructor(t){this.GameMap=t,this.MyElement=document.createElement("canvas"),this.MyElement.className="Map",this.Context=this.MyElement.getContext("2d"),this.SetCanvasDimensions(),this.ZoomToFit(),this.InitCenter(),this.Draw(),this.MyElement.addEventListener("click",(t=>{this.OnClick(t)})),this.Listners=new g([{Callback:this.OnScreenResize_ArrowFunction,EventName:"resize",Target:window},{Callback:this.OnMouseMove_ArrowFunction,EventName:"mousemove",Target:window},{Callback:this.OnThemeChange_ArrowFunction,EventName:"change",Target:window.matchMedia("(prefers-color-scheme: dark)")},{Callback:this.OnMouseDown_ArrowFunction,EventName:"mousedown",Target:document},{Callback:this.OnMouseUp_ArrowFunction,EventName:"mouseup",Target:document},{Callback:this.OnWheel_ArrowFunction,EventName:"wheel",Target:document}])}Draw(){this.DrawGround(),this.DrawArchitecture(),this.DrawPositions()}Update(){this.Clear(),this.Draw()}get PixelDensityMultiplier(){return window.devicePixelRatio}SetCanvasDimensions(){this.MyElement.width=window.innerWidth*this.PixelDensityMultiplier,this.MyElement.height=window.innerHeight*this.PixelDensityMultiplier}SetCanvasDimensionsSavingTransform(){const t=this.Context.getTransform();this.SetCanvasDimensions(),this.Context.transform(t.a,t.b,t.c,t.d,t.e,t.f)}Clear(){const t=this.Context.getTransform();this.Context.clearRect(-t.e/t.a,-t.f/t.a,this.MyElement.width/t.a,this.MyElement.height/t.a)}ZoomToFit(){const t=this.CalculateZoomToFit();this.Context.scale(t,t)}CalculateZoomToFit(){return Math.min((this.MyElement.width-10)/this.GameMap.Width,(this.MyElement.height-10)/this.GameMap.Width)}DrawGround(){const t=new Path2D(this.GameMap.Ground);this.DrawGroundFill(t),this.DrawGroundStroke(t)}DrawGroundFill(t){this.Context.fillStyle=window.matchMedia("(prefers-color-scheme: dark)").matches?"#2A2B2F":"#797C86",this.Context.fill(t)}DrawGroundStroke(t){this.Context.strokeStyle="#000",this.Context.lineWidth=this.StrokeWidth,this.Context.stroke(t)}DrawArchitecture(){const t=new Path2D(this.GameMap.Architecture);this.DrawArchitectureFill(t),this.DrawArchitectureStroke(t)}DrawArchitectureFill(t){this.Context.fillStyle="#FFF",this.Context.fill(t)}DrawArchitectureStroke(t){this.Context.strokeStyle="#000",this.Context.lineWidth=this.StrokeWidth,this.Context.stroke(t)}DrawPositions(){const t=new Path2D(this.MergePositionPaths());this.DrawPositionsFill(t),this.DrawPositionStroke(t)}DrawPositionsFill(t){this.Context.fillStyle="#99072130",this.Context.fill(t)}DrawPositionStroke(t){this.Context.strokeStyle="#990721",this.Context.lineWidth=1.5*this.StrokeWidth,this.Context.stroke(t)}MergePositionPaths(){let t="";for(const e of this.GameMap.Positions)t+=e.VectorPath+" ";return t}get StrokeWidth(){const t=this.Context.getTransform();return Math.min(1/t.a,.75)}PointToPosition(t){for(const e of this.GameMap.Positions)if(1==this.IsPointInPosition(t,e))return e}IsPointInPosition(t,e){return this.Context.isPointInPath(new Path2D(e.VectorPath),t.x*this.PixelDensityMultiplier,t.y*this.PixelDensityMultiplier)}IsPointInAnyPosition(t){for(const e of this.GameMap.Positions)if(1==this.IsPointInPosition(t,e))return 1;return 0}AboutPositionAtPoint(t){const e=this.PointToPosition({x:t.x,y:t.y});void 0!==e&&alert(e.Names.filter((t=>r.PositionNameLanguages.Value.get(t.Language))).map((t=>t.Name)).join("\n"))}HandleCursorStyle(t){this.MyElement.style.cursor=this.GetCursorStyle({x:t.x,y:t.y})}GetCursorStyle(t){return 1==this.IsMouseDown?"move":1==this.IsPointInAnyPosition({x:t.x,y:t.y})?"pointer":""}InitCenter(){const t=this.Context.getTransform().a,e=(this.MyElement.width/t-this.GameMap.Width)/2,s=(this.MyElement.height/t-this.GameMap.Height)/2;this.Context.transform(1,0,0,1,e,s)}get IsMouseDown(){return!!this.DragStartPoint}Drag(t){if(1==this.IsMouseDown){const e=this.Context.getTransform().a,s=t.x-this.DragStartPoint.x,i=t.y-this.DragStartPoint.y;this.Context.translate(s/e*this.PixelDensityMultiplier,i/e*this.PixelDensityMultiplier),this.Update(),this.UpdateDragStartPoint(t)}}UpdateDragStartPoint(t){this.DragStartPoint={x:t.x,y:t.y}}Zoom(t){const e=1/(1+.001*t.deltaY),s=25*Math.sign(t.deltaY);this.Context.scale(e,e),this.Context.translate(s,s),this.Update()}OnClick(t){this.AboutPositionAtPoint({x:t.x,y:t.y})}OnMouseDown(t){this.UpdateDragStartPoint(t),this.HandleCursorStyle(t)}OnMouseDown_ArrowFunction=t=>{this.OnMouseDown(t)};OnMouseUp(t){delete this.DragStartPoint,this.HandleCursorStyle(t)}OnMouseUp_ArrowFunction=t=>{this.OnMouseUp(t)};OnMouseMove(t){this.HandleCursorStyle(t),this.Drag(t)}OnMouseMove_ArrowFunction=t=>{this.OnMouseMove(t)};OnWheel(t){this.Zoom(t)}OnWheel_ArrowFunction=t=>{this.OnWheel(t)};OnScreenResize(){this.SetCanvasDimensionsSavingTransform(),this.Update()}OnScreenResize_ArrowFunction=()=>{this.OnScreenResize()};OnThemeChange(){this.Draw()}OnThemeChange_ArrowFunction=()=>{this.OnThemeChange()};Destruct(){this.Listners.Destruct()}}class D{static async Draw(){document.body.append(new m(await d.Fetch("Dust2")).MyElement)}}(class{static Init(){t.Init(),r.Init(),e.Init(),this.Draw()}static Draw(){D.Draw()}}).Init()})();